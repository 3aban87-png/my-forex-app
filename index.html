<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Pro MiniApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --green: #22c55e; --red: #ef4444; --text: #f8fafc; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .header { background: var(--card); padding: 15px; text-align: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-success { background: var(--green); color: white; }

        /* Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ */
        .signal-card { border-right: 5px solid var(--blue); }
        .buy { border-right-color: var(--green); }
        .sell { border-right-color: var(--red); }

        /* Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ */
        .navbar { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #334155; }
        .nav-item { background: none; border: none; color: #94a3b8; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--blue); }
        .nav-item i { font-size: 20px; }
    </style>
</head>
<body>
    <div class="header"><h1 id="page-title" style="font-size: 18px; margin: 0;">Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²Ù†Ø¯Ù‡</h1></div>

    <div id="signals-page" class="page active-page">
        <div id="signals-list">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²Ù†Ø¯Ù‡...</div>
    </div>

    <div id="copy-page" class="page">
        <div class="card">
            <h3>ğŸ”„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„</h3>
            <select id="conn-method" onchange="toggleConn()">
                <option value="meta">Ø±ÙˆØ´ Ø§Ø¨Ø±ÛŒ (MetaApi)</option>
                <option value="ea">Ø±ÙˆØ´ Ø§Ú©Ø³Ù¾Ø±Øª (EA)</option>
            </select>
            <div id="meta-inputs">
                <input type="text" id="acc" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ù…ØªØ§ØªØ±ÛŒØ¯Ø±">
                <input type="password" id="pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <input type="text" id="srv" placeholder="Ø³Ø±ÙˆØ± Ø¨Ø±ÙˆÚ©Ø±">
            </div>
            <div id="ea-info" style="display:none;">
                <p style="font-size: 12px; color: #fbbf24;">ÙØ§ÛŒÙ„ EA Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ú©Ø¯ 835971 Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
                <button class="btn-primary">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Øª</button>
            </div>
            <button class="btn-success" style="margin-top:10px;" onclick="saveConfig()">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </div>
    </div>

    <div id="calc-page" class="page">
        <div class="card">
            <h3>ğŸ§® Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡</h3>
            <input type="number" id="balance" placeholder="Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ ($)">
            <input type="number" id="risk" placeholder="Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© (Ù…Ø«Ù„Ø§Ù‹ 1)">
            <input type="number" id="stoploss" placeholder="ÙØ§ØµÙ„Ù‡ Ø§Ø³ØªØ§Ù¾ (Pip)">
            <button class="btn-primary" onclick="calculateLot()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ù‡</button>
            <div id="calc-result" style="margin-top: 15px; text-align: center; color: var(--green); font-weight: bold;"></div>
        </div>
    </div>

    <div id="news-page" class="page">
        <div class="card">
            <h3>ğŸ“¢ Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h3>
            <p style="color: #94a3b8; font-size: 13px;">Ø§Ø®Ø¨Ø§Ø± ÙØ§Ø±Ú©Ø³ Ùˆ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
            <button class="btn-primary" onclick="window.open('https://t.me/TP_OR_SL_XauUsd')">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…</button>
        </div>
    </div>

    <div id="support-page" class="page">
        <div class="card">
            <h3>ğŸ§ Ù…Ø±Ú©Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</h3>
            <p>Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ Ù…Ø§ Û²Û´ Ø³Ø§Ø¹ØªÙ‡ Ø¯Ø± Ø®Ø¯Ù…Øª Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ….</p>
            <button class="btn-primary">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</button>
        </div>
    </div>

    <nav class="navbar">
        <button class="nav-item" onclick="showTab('support-page', 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ')"><i>ğŸ§</i><span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span></button>
        <button class="nav-item" onclick="showTab('news-page', 'Ø§Ø®Ø¨Ø§Ø±')"><i>ğŸ“¢</i><span>Ø§Ø®Ø¨Ø§Ø±</span></button>
        <button class="nav-item" onclick="showTab('calc-page', 'Ù…Ø­Ø§Ø³Ø¨Ø§Øª')"><i>ğŸ§®</i><span>Ù…Ø­Ø§Ø³Ø¨Ù‡</span></button>
        <button class="nav-item" onclick="showTab('copy-page', 'Ú©Ù¾ÛŒâ€ŒØªØ±ÛŒØ¯')"><i>ğŸ”„</i><span>Ú©Ù¾ÛŒâ€ŒØªØ±ÛŒØ¯</span></button>
        <button class="nav-item active" onclick="showTab('signals-page', 'Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§')"><i>ğŸ“ˆ</i><span>Ø³ÛŒÚ¯Ù†Ø§Ù„</span></button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Ø³ÙˆÛŒÛŒÚ† Ø¨ÛŒÙ† ØµÙØ­Ø§Øª
        function showTab(id, title) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active-page');
            document.getElementById('page-title').innerText = title;
            event.currentTarget.classList.add('active');
        }

        // ØªØºÛŒÛŒØ± Ø±ÙˆØ´ Ø§ØªØµØ§Ù„
        function toggleConn() {
            const m = document.getElementById('conn-method').value;
            document.getElementById('meta-inputs').style.display = (m === 'meta') ? 'block' : 'none';
            document.getElementById('ea-info').style.display = (m === 'ea') ? 'block' : 'none';
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø² Ù¾Ø§ÛŒØªÙˆÙ†
        async function fetchSignals() {
            try {
                const res = await fetch('http://localhost:8000/signals');
                const signals = await res.json();
                const list = document.getElementById('signals-list');
                
                if (signals.length === 0) {
                    list.innerHTML = '<div style="text-align:center; margin-top:50px;">â˜• ÙØ¹Ù„Ø§Ù‹ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø§Ø² Ù†Ø¯Ø§Ø±ÛŒÙ…...</div>';
                    return;
                }

                list.innerHTML = '';
                signals.forEach(s => {
                    const isBuy = s.type === 'BUY';
                    list.innerHTML += `
                        <div class="card signal-card ${isBuy ? 'buy' : 'sell'}">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <b>ğŸ“Š ${s.symbol}</b>
                                <b style="color:${isBuy ? 'var(--green)' : 'var(--red)'}">${isBuy ? 'BUY ğŸŸ¢' : 'SELL ğŸ”´'}</b>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; font-size:12px; gap:8px;">
                                <div>ÙˆØ±ÙˆØ¯: ${s.entry}</div>
                                <div>ÙˆØ¶Ø¹ÛŒØª: ÙØ¹Ø§Ù„</div>
                                <div style="color:var(--green)">Ø­Ø¯ Ø³ÙˆØ¯: ${s.tp || '---'}</div>
                                <div style="color:var(--red)">Ø­Ø¯ Ø¶Ø±Ø±: ${s.sl || '---'}</div>
                            </div>
                        </div>`;
                });
            } catch (e) { console.log("API Error"); }
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù„Ø§Øª
        function calculateLot() {
            const bal = document.getElementById('balance').value;
            const rsk = document.getElementById('risk').value;
            const sl = document.getElementById('stoploss').value;
            if(bal && rsk && sl) {
                const res = (bal * (rsk / 100)) / (sl * 10);
                document.getElementById('calc-result').innerText = "Ø­Ø¬Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: " + res.toFixed(2) + " Lot";
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù¾ÛŒ ØªØ±ÛŒØ¯
        function saveConfig() {
            const data = { acc: document.getElementById('acc').value, method: document.getElementById('conn-method').value };
            tg.sendData(JSON.stringify(data));
        }

        setInterval(fetchSignals, 3000);
        fetchSignals();
    </script>
</body>
</html>
